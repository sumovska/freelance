<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Logo</title>

	<link href="bootstrap.min.css" rel="stylesheet"/>
	<script type="template" id="editable_row_template">
		<td data-type="row_item_select"><input type="checkbox"></td>
		<td data-type="row_item_date"></td>
		<td data-type="row_item_serial"></td>
		<td>
			<input class="form-control" type="text" data-type="row_item_name_first">
		</td>
		<td>
			<input class="form-control" type="text" data-type="row_item_name_last">
		</td>
		<td>
			<input class="form-control" type="date" data-type="row_item_dob">
		</td>
		<td>
			<select name="Gender" class="form-control" data-type="row_item_gender">
				<option value="unspecified">ified</option>
				<option value="male">Male</option>
				<option value="female">Female</option>
			</select>
		</td>
		<td>
			<div class="input-group">
				<input type="text" class="form-control" data-type="row_item_surgery">
				<div class="input-group-btn">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
					<ul class="dropdown-menu dropdown-menu-right" role="menu" data-type="row_item_surgery_options"></ul>
				</div>
			</div>
		</td>
		<td>
			<div class="input-group">
				<input type="text" class="form-control" data-type="row_item_surgeon">
				<div class="input-group-btn">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
					<ul class="dropdown-menu dropdown-menu-right" role="menu" data-type="row_item_surgeon_options"></ul>
				</div>
			</div>
		</td>
		<td>
			<div class="input-group">
				<input type="text" class="form-control" data-type="row_item_clinic">
				<div class="input-group-btn">
					<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
					<ul class="dropdown-menu dropdown-menu-right" role="menu" data-type="row_item_clinic_options"></ul>
				</div>
			</div>
		</td>
		<td>
			<button type="button" class="btn btn-default" data-toggle="modal" data-target="#view_modal">View</button>
		</td>
	</script>

	<script type="template" id="row_header_template">
		<th>Select</th>
		<th>Date/Time</th>
		<th>Serial Number</th>
		<th>First Name</th>
		<th>Last Name</th>
		<th>DOB</th>
		<th>Gender</th>
		<th>Surgery</th>
		<th>Surgeon</th>
		<th>Clinic/Clinician</th>
		<th>View</th>
	</script>

	<script>
		/*
		 if (window.magichat === undefined) {
		 log_info = console.log.bind(console);
		 } else {
		 log_info = window.magichat.log_info;
		 }
		 */

		function find_item_with_datatype(node, id) {
			for (var i = 0; i < node.children.length; i++) {
				var matched = find_item_with_datatype(node.children[i], id);
				if (matched) {
					return matched;
				}
			}
			if (node.getAttribute("data-type") == id) {
				return node
			}
		}

		function set_value(node, value) {
			for (var prop in node) {
				if (prop == "innerText") {
					node.innerText = value;
					break;
				}
				if (prop == "value") {
					node.value = value;
					break;
				}
			}
		}

		function set_options(node, options) {
			if (node) {
				node.innerHTML = options.map(function (item) {
					if (item === '+ Add New') {
						return "<li><a href=\"#\" onclick=\"show_modal('#" + $(node).attr('data-type').replace('_options', '_modal').replace('row_item_', '') + "')\">" + item + "</a></li>";
					} else {
						return "<li><a href=\"#\">" + item + "</a></li>";
					}
				}).join("\n");
			}
		}

		function show_modal(id) {
			$('.modal').modal('hide');
			$(id).modal();
		}

		if (!String.prototype.endsWith) {
			Object.defineProperty(String.prototype, 'endsWith', {
				value: function (searchString, position) {
					var subjectString = this.toString();
					if (position === undefined || position > subjectString.length) {
						position = subjectString.length;
					}
					position -= searchString.length;
					var lastIndex = subjectString.indexOf(searchString, position);
					return lastIndex !== -1 && lastIndex === position;
				}
			});
		}

		function set_view(mode, header_template, row_template, listing) {
			//log_info("Got listing for %s view!", [mode]);
			var view = document.getElementById(mode);
			view.innerHTML = "<tbody><tr>" + document.getElementById(header_template).innerHTML + "</tr></tbody>"
			tbody = view.firstElementChild;
			listing.map(function (data) {
				var row = document.createElement("tr");
				row.innerHTML = document.getElementById(row_template).innerHTML;
				for (var k in data) {
					var item = find_item_with_datatype(row, "row_item_" + k);
					if (item) {
						if (k.endsWith("_options")) {
							set_options(item, data[k]);
						} else {
							set_value(item, data[k]);
						}
					}
				}
				tbody.appendChild(row);
			});
			//log_info("Completed listing[%s]", [listing.length]);
		}

		function on_load() {
			window.magichat.event_onload(set_view);
			window.magichat.set_device_listener(
					function (status, percentage) {
						map = {
							"stuck": "stuck",
							"connected": "connected",
							"disconnected": "disconnected"
						};
						document.getElementById("device-status").innerText = map[status];
						document.getElementById("device-load-percentage").innerText = percentage;
					});

			setInterval(function () {
				window.magichat.poll();
			}, 50);
		}

		// This version, replace 'on_load' with a dummy stub, until he has access to gitlab and can build his own version
		function on_load() {
			row = {
				'date': '2015-01-01',
				'dob': '1985-01-01',
				'gender': 'male',
				'serial': '1234-1234',
				'name_first': 'Charlie',
				'name_last': 'Brown',
				'surgeon': 'Sam Reynold',
				'surgeon_options': ['Sam Reynold', '+ Add New'],
				'surgery': 'Kings Day Surgery',
				'surgery_options': ['Kings Day Surgery', '+ Add New'],
				'clinic': 'Hills Clinic',
				'clinic_options': ['Hills Clinic', '+ Add New']
			};
			set_view('cr220_view', 'row_header_template', 'editable_row_template', [row, row, row, row]);
			set_view('crf_view', 'row_header_template', 'editable_row_template', [row, row, row]);
			set_view('history_view', 'row_header_template', 'editable_row_template', [row, row]);
		}

	</script>
</head>
<body onLoad="on_load()">
	<div class="container">
		<h1>Logo</h1>
		<p>Device is <span id="device-status"></span> and logs have been read at <span id="device-load-percentage"></span>%.</p>
		<ul class="nav nav-tabs">
			<li role="presentation" class="active"><a href="#tab_cr220" role="tab" data-toggle="tab">CR220</a></li>
			<li role="presentation"><a href="#tab_crf" role="tab" data-toggle="tab">CRF</a></li>
			<li role="presentation"><a href="#tab_history" role="tab" data-toggle="tab">History</a></li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane" role="tabpanel" id="tab_crf">
				<div>
					<label><input type="checkbox"> Select All</label>
					<table class="table" id="crf_view"></table>
				</div>
			</div>
			<div class="tab-pane" role="tabpanel" id="tab_history">
				<div>
					<label><input type="checkbox"> Select All</label>
					<table class="table" id="history_view"></table>
				</div>
			</div>
			<div class="tab-pane active" id="tab_cr220">
				<div>
					<label><input type="checkbox"> Select All</label>
					<table class="table" id="cr220_view"></table>
				</div>
			</div>
			<button type="button" class="btn btn-default">Delete</button>
			<button type="button" class="btn btn-default">Save</button>
			<button type="button" class="btn btn-default">Export</button>
			<button type="button" class="btn btn-default">Send</button>
		</div>
	</div>

	<!-- Surgeon Modal -->
	<div class="modal fade bs-example-modal-sm" id="surgeon_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<form action="#">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Add New Surgeon</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Surgeon Name">
						</div>
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Cochlear ID (Optional)">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" placeholder="E-mail address">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Surgery Modal -->
	<div class="modal fade" id="surgery_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<form action="#">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Add New Surgery</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Surgery Name">
						</div>
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Cochlear ID (Optional)">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" placeholder="E-mail address">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Clinic Modal -->
	<div class="modal fade" id="clinic_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<form action="#">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Add New Clinic</h4>
					</div>
					<div class="modal-body">
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Clinic Name">
						</div>
						<div class="form-group">
							<input type="text" class="form-control" placeholder="Cochlear ID (Optional)">
						</div>
						<div class="form-group">
							<input type="email" class="form-control" placeholder="E-mail address">
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<!-- Clinic Modal -->
	<div class="modal fade" id="view_modal" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<form action="#">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">Charlie Brown</h4>
					</div>
					<div class="modal-body">
						<div class="row">
							<div class="col-xs-2">
								<div class="form-group">
									<label>Date/Time</label>
									<div>2015
									-
									01
									-
									01</div>
								</div>
							</div>
							<div class="col-xs-2">
								<div class="form-group">
									<label>Serial Number</label>
									<div>1234
									-
									1234</div>
								</div>
							</div>
							<div class="col-xs-2">
								<div class="form-group">
									<label>First Name</label>
									<input class="form-control" type="text" value="Charlie">
								</div>
							</div>
							<div class="col-xs-2">
								<div class="form-group">
									<label>Last Name</label>
									<input class="form-control" type="text" value="Brown">
								</div>
							</div>
							<div class="col-xs-3">
								<div class="form-group">
									<label>DOB</label>
									<input class="form-control" type="date" value="1985-01-01">
								</div>
							</div>
							<div class="col-xs-1">
								<div class="form-group">
									<label>Gender</label>
									<select name="Gender" class="form-control">
										<option value="unspecified">ified</option>
										<option value="male" selected>Male</option>
										<option value="female">Female</option>
									</select>
								</div>
							</div>
						</div>
						<div class="row">
							<div class="col-xs-4">
								<div class="form-group">
									<label>Surgery</label>
									<div class="input-group">
										<input type="text" class="form-control" value="Kings Day Surgery">
										<div class="input-group-btn">
											<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
											<ul class="dropdown-menu dropdown-menu-right" role="menu">
												<li><a href="#">Kings Day Surgery</a></li>
												<li><a href="#" onclick="show_modal('#surgery_modal')">+ Add New</a></li>
											</ul>
										</div>
									</div>
								</div>
							</div>
							<div class="col-xs-4">
								<div class="form-group">
									<label>Surgeon</label>
									<div class="input-group">
										<input type="text" class="form-control" value="Sam Reynold">
										<div class="input-group-btn">
											<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
											<ul class="dropdown-menu dropdown-menu-right" role="menu">
												<li><a href="#">Sam Reynold</a></li>
												<li><a href="#" onclick="show_modal('#surgery_modal')">+ Add New</a></li>
											</ul>
										</div>
									</div>
								</div>
							</div>
							<div class="col-xs-4">
								<div class="form-group">
									<label>Clinic/Clinician</label>
									<div class="input-group">
										<input type="text" class="form-control" value="Hills Clinic">
										<div class="input-group-btn">
											<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
											<ul class="dropdown-menu dropdown-menu-right" role="menu">
												<li><a href="#">Hills Clinic</a></li>
												<li><a href="#" onclick="show_modal('#surgery_modal')">+ Add New</a></li>
											</ul>
										</div>
									</div>
								</div>
							</div>
						</div>
						<img style="width:100%;" src="image.png" alt="">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default pull-left">Print</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
						<button type="button" class="btn btn-primary">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="jquery.min.js"></script>
	<script src="bootstrap.min.js"></script>
</body>
</html>
